{% extends "base.html" %}

{% block head %}
    <meta charset=utf-8 />
    <title></title>
{#    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />#}
{#    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>#}
{#    <script src="https://unpkg.com/supercluster@2.3.0/dist/supercluster.min.js"></script>#}
    <link rel="stylesheet" type="text/css" href="/static/css/map.css">
    <link rel="stylesheet" href="/static/sankey/examples/css/style.css" />

{% endblock %}


{% block content %}
{#    <div id='mapid' class='map' style="width:900px; height: 900px; position: relative  "> </div>#}
{#    <script src="../static/js/map.js"></script>#}
 <div id="myCarousel" class="carousel slide col-md-12" data-interval="false" data-ride="carousel">
     <div class="carousel-inner" role="listbox">

        <div class="item">
            <div id="zero" class="row">
                <div class="row">
                    <div class="col-sm-offset-1 col-sm-10">
                    <h3 id="countryName1"></h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4" style="height: 350px;">
                        <canvas class="col-sm-offset-1" id="radar-compare-attacktype"></canvas>
                    </div>

                    <div id="canvas-holder-groups" class="col-sm-4" style="height: 350px;">
                        <canvas id="radar-compare-targettype"></canvas>
                    </div>

                    <div class="col-sm-4" style="height: 350px;">
                        <canvas id="radar-compare-groups"></canvas>
                    </div>
                </div>

                <div class="row">
                    <div id="canvas" class="col-sm-offset-4 col-sm-4" style="height: 350px;">
                        <canvas id="scatter-compare-attacks"></canvas>
                    </div>
                    <div class="col-sm-4">
                        <a id="addData" class="btn btn-default">Add Data</a>
                    </div>
                </div>

            </div>
        </div>


        <div class="item active">
            <div id="one" class="row">
                <div id="map" class="col-sm-10"></div>
                <div class="col-sm-2">
                    <div class="panel panel-default facets">
                        <div class="panel-heading" data-toggle="collapse" data-target="#attackFacets" aria-expanded="false" aria-controls="attackFacets">Attack Type</div>
                        <div class="panel-body collapse" id="attackFacets">
                            {% for attack_type in facets.attacktype %}
                                <div class="checkbox">
                                    <label>
                                        <input id="facet-{{attack_type}}" type="checkbox" value="{{ attack_type }}" onclick='handleFacetClick(this);'>
                                        {{ attack_type }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="panel panel-default facets">
                        <div class="panel-heading" data-toggle="collapse" data-target="#targetFacets" aria-expanded="false" aria-controls="targetFacets" >Target Type</div>
                        <div class="panel-body collapse" id="targetFacets">
                            {% for attack_type in facets.targettype %}
                                <div class="checkbox">
                                    <label>
                                        <input id="facet-{{attack_type}}" type="checkbox" value="{{ attack_type }}" onclick='handleFacetClick(this);'>
                                        {{ attack_type }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="panel panel-default facets">
                        <div class="panel-heading" data-toggle="collapse" data-target="#mapFacets" aria-expanded="false" aria-controls="mapFacets" >
                            Map Options
                        </div>
                        <div class="panel-body collapse" id="mapFacets">
                            <input type="checkbox" id="polygonsAllAttack"> Attacks number
            {#                <input type="checkbox" id="flowChart"> Show Flow Chart#}

                        </div>
                    </div>
                    <div class="panel panel-default facets">
                        <div class="panel-heading">
                            Selection
                        </div>
                        <div class="panel-body" id="selectionFacets">
                            <div class="row" id="selectedCountries">
{#                                <div class="col-sm-6">Selected Country</div>#}
{#                                <div class="col-sm-4"><a id="sectionToggle" class="btn btn-default btn-xs">BUTTON</a></div>#}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    
        <div class="item">
            <div id="two" class="row">
                <div class="row">
                    <div class="col-sm-offset-1 col-sm-10">
                    <h3 id="countryName"></h3>
                    </div>
                </div>

                <div class="row">
                    <div id="bar1" class="col-sm-5"></div>
                </div>
                <div class="row">
                    <div id='sankey' class="col-sm-5" style="margin-top:50px; height: 400px;">&nbsp;</div>
                    <div id="wordle" class="col-sm-5 col-sm-offset-1"></div>
                </div>      

                <div class="row">
                    <div id="canvas-holder-groups" class="col-sm-4" style="height: 350px;">
                        <canvas id="radar-attacktype"></canvas>
                    </div>

                    <div id="canvas-holder-groups" class="col-sm-4" style="height: 350px;">
                        <canvas id="radar-targettype"></canvas>
                    </div>

                    <div id="canvas-holder-groups" class="col-sm-4" style="height: 350px;">
                        <canvas id="radar-groups"></canvas>
                    </div>
                </div>

                <div class="row">
                    <div id="canvas" class="col-sm-offset-4 col-sm-4" style="height: 350px;">
                        <canvas id="scatter-attacks" style="height: 350px;"></canvas>
                    </div>
                    <div class="col-sm-4">
                        <a id="addData" class="btn btn-default">Add Data</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
    function loadCountryData(selectedCountry, previousCountry){
        var countryData;
        $.getJSON('{{ url_for("get_country", country=selectedCountry) }}'  + selectedCountry, function(countryData) {
            console.log("Selected:", selectedCountry, "Previous:"+ previousCountry);
            if (previousCountry === selectedCountry) return previousCountry;
            previousCountry = selectedCountry;
            plotCountryStuffs(countryData);

            return previousCountry;
        })
    }

    function loadComparisonData(listClickedCountries) {
        console.log('do nothing')
      
        scatter_config = plot_scatter(empty=true);
        var scatter_ctx = document.getElementById("scatter-compare-attacks").getContext("2d");
        window.myScatterCompareChart = new Chart(scatter_ctx, scatter_config)

        listClickedCountries.forEach(function (country) {
            $.getJSON('{{ url_for("get_country", country=selectedCountry) }}'  + country, function(countryData) {
                console.log("compare", countryData);
                plotCompareCountryStuffs(countryData);
                plot_scatter(data=countryData, 'attacks_per_period', chart=window.myScatterCompareChart, empty=false);
            })
        })
    }

    function onListClickedCountriesChanged(listClickedCountries){
        d3.select("#selectedCountries").selectAll("div").remove();
        var row = d3.select("#selectedCountries");
{#         <div class="col-sm-6">Selected Country</div>#}
{#        <div class="col-sm-4"><a id="sectionToggle" class="btn btn-default btn-xs">BUTTON</a></div>#}
        for(c in listClickedCountries ){
            row.append("div").attr("class", "col-sm-6").text(listClickedCountries[c]);
            row.append("div").attr("class", "col-sm-4")
                .append("a").attr("class", "btn btn-default btn-xs").attr("name",listClickedCountries[c]).text("Show")
                .attr("id", "sectionToggle").on("click", function (e){
                    console.log("click");
                    $('#myCarousel').carousel('next');
                    loadCountryData(listClickedCountries[c], "");
                });
        }

        if (listClickedCountries.length >= 2){
//            var cmp = "/compare/Belgium/France";
            console.log("two or more countries");
            row.append("div").attr("class", "col-sm-10")
                .append("a").attr("class", "btn btn-success btn-xs")
                            .attr("id", "btnCompare")
//                            .attr("href", cmp)
                            .text("Compare")
                            .on("click", function(e) {
                                 console.log('clicked compare');
                                 $('#myCarousel').carousel('prev');
                                 loadComparisonData(listClickedCountries);
                            })

        }else{
            console.log("less than two countries");
        }
    }

    </script>

    <script>
{#    var btn = document.getElementById('sectionToggle');#}
    var zero = document.getElementById('zero');
    var one = document.getElementById('one');
    var two = document.getElementById('two');
    var previousCountry = "";

    two.addEventListener('click', function (e){
        console.log("click");
{#        one.style.display = 'block';#}
{#        two.style.display = 'none';#}
//        $('#myCarousel').carousel('prev');
    });

    zero.addEventListener('click', function (e){
        console.log("click");
{#        one.style.display = 'block';#}
{#        two.style.display = 'none';#}
        $('#myCarousel').carousel('next');
    });


    </script>


    <script type="text/javascript">
    function getMinMax(object) {
        var max = 0;
        var maxItem = null;
        var min = 100000;
        var minItem = null;
        for (var prop in object) {
            var item = object[prop]['attacks_count'];
            {#        console.log(item);#}
            if (item > max) {
                max = item;
                maxItem = item;
            }
            if (item < min) {
                min = item;
                minItem = item;
            }
        }
        return [maxItem, minItem];
    }

    </script>


    <script type=text/javascript>

    var attackLocations = {{attack_locations|tojson}};
    var eventids = Object.keys(attackLocations);
    var locations = Object.values(attackLocations);
    var facets = {{facets|tojson}};

    var countryBasics={{ country_basics|tojson }}
    var listClickedCountries=[];
    var MinMax=getMinMax(countryBasics);
    var minAttack=MinMax[1];
    var maxAttack=MinMax[0]
    var showCountryPolygonsClicked=0;
    {#        console.log(maxAttack)#}

    function initParamMap(a, b) {
        return function() {
            console.log(a, b);

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 2,
                minZoom: 2,
                center: {lat: 30, lng: 0},
                styles: [
                    {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                    {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                    {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{color: '#263c3f'}]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#6b9a76'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{color: '#38414e'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{color: '#212a37'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#9ca5b3'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{color: '#746855'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{color: '#1f2835'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#f3d19c'}]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{color: '#2f3948'}]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{color: '#17263c'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#515c6d'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.stroke',
                        stylers: [{color: '#17263c'}]
                    }
                ]
            });

            markers = initMarkers(locations);
            // gridSize determins the number of clusters. larger grid size --> less clusters
            var mcOptions = {gridSize: 200, maxZoom: 15, imagePath: 'static/imgs/mapClusterImages/m'};
            var markerCluster = new MarkerClusterer(map, markers,mcOptions);


            //the whole stuff below does the polygon shit.
            //makes the country polygons. not really sure how to move it into a seperate function.
            var geojson = map.data.loadGeoJson('./static/data/geodata.json');


            map.data.setStyle({
                strokeWeight:0.5,
                strokeColor:'#000000',
                strokeOpacity:0.01,
                fillColor:'0x00000000',
                fillOpacity:0.01
            })

            map.data.addListener('mouseover', function(e) {
                var country= e.feature.f.name;
                if (!(listClickedCountries.indexOf(country)>=0)) {
                    map.data.overrideStyle(e.feature, {
                        strokeWeight: 1,
                        strokeColor: '#ff0000',
                        strokeOpacity: 1,
                        fillColor: '#ff0000',
                        fillOpacity: 0.2
                    });
                };
            });

            map.data.addListener('mouseout', function(e) {
                var country= e.feature.f.name;
                if (!(listClickedCountries.indexOf(country)>=0) && showCountryPolygonsClicked===0 ){
                    map.data.overrideStyle(e.feature, {
                        strokeWeight: 1,
                        strokeColor: '#000000',
                        strokeOpacity: 0.01,
                        fillColor: '0x00000000',
                        fillOpacity: 0.001
                    });
                }else if (!(listClickedCountries.indexOf(country)>=0) && showCountryPolygonsClicked===1){
                    map.data.overrideStyle(e.feature, {
                        strokeWeight:2,
                        strokeColor:'#000000',
                        strokeOpacity:0.1,
                        fillColor:'#23ff09',
                        fillOpacity:getOpacity(e.feature.f.name)
                    });
                };
            });

            map.data.addListener('click', function(e) {
                var country= e.feature.f.name;
                console.log(e.feature.f.name);
                if (listClickedCountries.indexOf(country)>=0){
                    map.data.overrideStyle(e.feature, {
                        strokeWeight: 1,
                        strokeColor: '#ff0000',
                        fillColor:'#ff0000',
                        fillOpacity:'0.1',
                    });
                    listClickedCountries.splice(listClickedCountries.indexOf(country),1);
                    onListClickedCountriesChanged(listClickedCountries);
                    //remove country to comparison
                }else{
                    map.data.overrideStyle(e.feature, {
                        strokeWeight: 1,
                        strokeColor: '#ff0000',
                        fillColor:'#ff0000',
                        fillOpacity:'0.5'
                    });
                    listClickedCountries.push(country);
                    console.log(listClickedCountries);
                    onListClickedCountriesChanged(listClickedCountries);
                    //add country to comparison
                }
            });


            function showCountryPolygons() {
                map.data.revertStyle();
                map.data.setStyle(function(e){
                    return {
                        strokeWeight: 0.5,
                        strokeColor: '#000000',
                        strokeOpacity: 0.1,
                        fillColor: '#23ff09',
                        fillOpacity: getOpacity(e.f.name)
                    }
                });
            };

            function getOpacity(countryName) {
{#                console.log(countryName)#}
                try {
                    var attackCounts = countryBasics[countryName]['attacks_count']
                {#console.log(attackCounts);#}
                    var countryOpacity = (0.99 - 0.01) * Math.cbrt((attackCounts - minAttack) / (maxAttack - minAttack))+ 0.01;
                    {#                    console.log(countryOpacity);#}
                    return countryOpacity;
                }
                catch (err){
                    return 0.01;
                }
            }

            function unshowCountryPolygons() {
                {#        console.log("here i am")#}
                map.data.revertStyle();
                map.data.setStyle({
                    strokeWeight:0.5,
                    strokeColor:'#000000',
                    strokeOpacity:0.01,
                    fillColor:'#0x00000000',
                    fillOpacity:0.01
                });
            };

            //listens to toggling that one button or not.
            window.onload = function() {
                $("#polygonsAllAttack").change(function(){
                    if (this.checked) {
                        {#                console.log("toggle 1");#}
                        showCountryPolygons();
                        showCountryPolygonsClicked=1;
                    }else {
                        {#                console.log("toggle 2");#}
                        unshowCountryPolygons();
                        showCountryPolygonsClicked=0;
                    }
                });

                Object.keys(facets).forEach(function(facet_type) {
                  Object.keys(facets[facet_type]).forEach(function(facet_name) {
{#                    console.log("adding click stuffs to:", facet_type, facet_name);#}
                    var id_ = '#facet-' + facet_name.replace(/[&-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    $(id_).change(function(){
{#                      console.log(facet_name);#}
                      if (this.checked) {
                        alert('You clicked me!' + facet_type + ' ' + facet_name );
                      }else {
                        alert('You unclicked me!' + facet_type + ' ' + facet_name);
                      }
                    });
                  });
                });


            };
        }}
    var map ;
    var markers = [];

    </script>



    <script>
    // Adds a marker to the map and push to the array.
      function addMarker(location) {
        var marker = new google.maps.Marker({
          position: location,
          map: map
        });
        markers.push(marker);
      }

      // Sets the map on all markers in the array.
      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setMapOnAll(null);
      }

      // Shows any markers currently in the array.
      function showMarkers() {
        setMapOnAll(map);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }
    </script>

    <script>
    var initMarkers = function(locations){
        var markers = locations.map(function(location, i) {
                var markerImg = "static/imgs/map_markers/"+i%5+".png";
                var marker = new google.maps.Marker({
                    position: location,
                    icon: markerImg
                });

                var eventid = eventids[i];

                marker.addListener('click', function() {
//                    $.getJSON('{{ url_for('get_attack', attack_id=eventid) }}', function(current_attack_data) {
                    $.getJSON('{{ url_for("get_attack", attack_id=eventid) }}'  + eventid, function(current_attack_data) {
//                    $.getJSON('{{ url_for("get_marker", attack_id=eventid) }}'  + eventid, function(current_attack_data) {

                      var titleString;
                      var ref;
 
                      // If cluster, display aggregated view, otherwise - single attack
                      if ( current_attack_data.markerType === 'individual' ) {
                          console.log('Found an individual');
                          titleString = current_attack_data.country;
                          ref = "/attack/"+eventids[i];
                      } else {
                          console.log('Found a cluster');
                          titleString = 'This is a cluster'
                          ref = "/marker/"+eventids[i]
                      }

                      console.log(titleString, ref); 

                      var contentString = '<div id="content" class="marker-info">' +
                            '<h4 id="firstHeading" class="firstHeading">'+current_attack_data.date+'</h4>' +
                            '<div id="bodyContent">' +
                                '<p>' + titleString + '</p>' +
                                '<a href="'+ref+'">View attack</a>' +
                            '</div>' +
                          '</div>';

                      console.log(contentString);

                      var infowindow = new google.maps.InfoWindow({
                        content: contentString
                      });

                      infowindow.open(map, marker);
                    });
                });

          return marker;
        });
        return markers;
    }
    </script>


    <script> var initMap = initParamMap(2, 3);  </script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="/static/js/counts.js"></script>
    <script src="/static/js/sankey.js"></script>
    <script src="/static/sankey/ext/raphael.js" type="text/javascript"></script>
    <script src="/static/sankey/ext/jquery.js" type="text/javascript"></script>
    <script src="/static/sankey/js/sankey.js" type="text/javascript"></script>

    <script src="/static/radar/Chart.bundle.js"></script>
    <script src="/static/radar/samples/utils.js"></script>
    <script src="/static/js/radar.js"></script>
    <script src="/static/js/scatterplot.js"></script>


    <script src="/static/js/loadCountry.js"></script>
    <script src="/static/js/compareCountries.js"></script>


<!--    <script src="/static/js/require.js" type="text/javascript"></script> -->
    <script src="/static/js/d3.layout.cloud.js" type="text/javascript"></script>
    <script src="/static/js/wordle.js" type="text/javascript"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDV99ga8LUQQ_z6gN_tjq3vNSPAZVo_D6Y&callback=initMap">
    </script>




{% endblock %}





