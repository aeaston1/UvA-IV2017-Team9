{% extends "base.html" %}

{% block head %}
    <meta charset=utf-8 />
    <title></title>
{#    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />#}
{#    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>#}
{#    <script src="https://unpkg.com/supercluster@2.3.0/dist/supercluster.min.js"></script>#}
    <link rel="stylesheet" type="text/css" href="../static/css/map.css">
    <style>
    #map {
        height: 90%;
      }
    </style>

{% endblock %}


{% block content %}
{#    <div id='mapid' class='map' style="width:900px; height: 900px; position: relative  "> </div>#}
{#    <script src="../static/js/map.js"></script>#}
    <div class="row">
    <div id="map" class="col-sm-10"></div>
    <div class="col-sm-2">
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#targetFacets" aria-expanded="false" aria-controls="targetFacets" >Target Type</div>
            <div class="panel-body" id="targetFacets">
                {% for attack_type in facets.targettype %}
                    <div class="checkbox">
                        <label>
                            <input id="facet-{{attack_type}}" type="checkbox" value="{{ attack_type }}" onclick='handleFacetClick(this);'>
                            {{ attack_type }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#attackFacets" aria-expanded="false" aria-controls="attackFacets">Attack Type</div>
            <div class="panel-body" id="attackFacets">
                {% for attack_type in facets.attacktype %}
                    <div class="checkbox">
                        <label>
                            <input id="facet-{{attack_type}}" type="checkbox" value="{{ attack_type }}" onclick='handleFacetClick(this);'>
                            {{ attack_type }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div>
    </div>
    <script type=text/javascript>

        var attackLocations = {{attack_locations|tojson}};
        var eventids = Object.keys(attackLocations);
        var locations = Object.values(attackLocations);
        var facets = {{facets|tojson}};
        console.log(facets);
        
        console.log(Object.keys(facets.attacktype));
{#        var attackData = {{attack_data}};#}

         function initParamMap(a, b) {
           return function() {
                console.log(a, b);

                var map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 2,
                  center: {lat: 30, lng: 0},
                   styles: [
                {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                {
                  featureType: 'administrative.locality',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#d59563'}]
                },
                {
                  featureType: 'poi',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#d59563'}]
                },
                {
                  featureType: 'poi.park',
                  elementType: 'geometry',
                  stylers: [{color: '#263c3f'}]
                },
                {
                  featureType: 'poi.park',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#6b9a76'}]
                },
                {
                  featureType: 'road',
                  elementType: 'geometry',
                  stylers: [{color: '#38414e'}]
                },
                {
                  featureType: 'road',
                  elementType: 'geometry.stroke',
                  stylers: [{color: '#212a37'}]
                },
                {
                  featureType: 'road',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#9ca5b3'}]
                },
                {
                  featureType: 'road.highway',
                  elementType: 'geometry',
                  stylers: [{color: '#746855'}]
                },
                {
                  featureType: 'road.highway',
                  elementType: 'geometry.stroke',
                  stylers: [{color: '#1f2835'}]
                },
                {
                  featureType: 'road.highway',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#f3d19c'}]
                },
                {
                  featureType: 'transit',
                  elementType: 'geometry',
                  stylers: [{color: '#2f3948'}]
                },
                {
                  featureType: 'transit.station',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#d59563'}]
                },
                {
                  featureType: 'water',
                  elementType: 'geometry',
                  stylers: [{color: '#17263c'}]
                },
                {
                  featureType: 'water',
                  elementType: 'labels.text.fill',
                  stylers: [{color: '#515c6d'}]
                },
                {
                  featureType: 'water',
                  elementType: 'labels.text.stroke',
                  stylers: [{color: '#17263c'}]
                }
              ]
                });

        var markers = initMarkers(locations);
        // gridSize determins the number of clusters. larger grid size --> less clusters
        var mcOptions = {gridSize: 200, maxZoom: 15, imagePath: 'static/imgs/mapClusterImages/m'};
        var markerCluster = new MarkerClusterer(map, markers,mcOptions);
    }}

{#        makemap(data);#}
    </script>
    <script>
    var initMarkers = function(locations){
        console.log("init markers !!!!");
        var markers = locations.map(function(location, i) {
                var markerImg = "static/imgs/map_markers/"+i%5+".png";
                var marker = new google.maps.Marker({
                    position: location,
                    icon: markerImg
                });
                var y = eventids[i].substring(0, 4);
                    var m = eventids[i].substring(4, 6);
                    var d = eventids[i].substring(6, 8);
                    var date = y + "-" + m + "-" + d;

                    var contentString = '<div id="content">' +
                        '<p>'+date +'</p>'+
                        '<a href="/attack/'+eventids[i]+'">View attack</a>'
                        '</div>';
                var infowindow = new google.maps.InfoWindow({
                     content: contentString
                });
                marker.addListener('click', function() {
                    infowindow.open(map, marker);

                });
          return marker;
        });
        return markers;
    }
    </script>


    <script> var initMap = initParamMap(2, 3);  </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDV99ga8LUQQ_z6gN_tjq3vNSPAZVo_D6Y&callback=initMap">
    </script>


{% endblock %}





